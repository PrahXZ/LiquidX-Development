package net.ccbluex.liquidbounce.features.module.modules.exploit.disablers.specials

import net.ccbluex.liquidbounce.event.PacketEvent
import net.ccbluex.liquidbounce.event.WorldEvent
import net.ccbluex.liquidbounce.features.module.modules.exploit.disablers.DisablerMode
import net.ccbluex.liquidbounce.features.value.*
import net.ccbluex.liquidbounce.utils.PacketUtils
import net.minecraft.network.play.client.*
import net.minecraft.util.BlockPos
import net.minecraft.util.EnumFacing

class VulcanDisabler : DisablerMode("Vulcan") {


    private val vulcanautoblock = BoolValue("VulcanAutoBlock", false)
    private val NoBPValue = BoolValue("${valuePrefix}-NoBadPacket", true)
    private val delayValue = IntegerValue("${valuePrefix}-PacketDelay", 6, 3, 10)
    private var C03Value = 0


    /*
    // TODO: This disabler was made by Dg636 (C00LC0D35), all credits to him.
    */

    override fun onEnable() {
        C03Value = -15
    }
    override fun onWorld(event: WorldEvent) {
        C03Value = -15
    }
    override fun onPacket(event: PacketEvent) {
        val packet = event.packet

        if (vulcanautoblock.get()) {
            if (packet is C17PacketCustomPayload) {
                event.cancelEvent()
                disabler.debugMessage("Fix AutoBlock Packets")
            }
        }

        if (packet is C03PacketPlayer) {
            C03Value++
            if (packet.isMoving) {
                if (C03Value >= delayValue.get()) {
                    PacketUtils.sendPacketNoEvent(
                            C07PacketPlayerDigging(C07PacketPlayerDigging.Action.STOP_DESTROY_BLOCK,
                                    if (NoBPValue.get()) { BlockPos.ORIGIN } else { BlockPos(mc.thePlayer.posX, mc.thePlayer.posY, mc.thePlayer.posZ) }, EnumFacing.DOWN)
                    )
                    C03Value = 0
                } else if (C03Value == delayValue.get() - 2) {
                    PacketUtils.sendPacketNoEvent(
                            C07PacketPlayerDigging(C07PacketPlayerDigging.Action.START_DESTROY_BLOCK,
                                    BlockPos.ORIGIN, EnumFacing.DOWN)
                    )
                }
            }
        }
    }
}
